---
title: "Surgical Report"
output: 
  html_document:
    toc: true
    toc_depth : 6
    
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(DT)
library(dplyr)
library(plotly)
library(ggplot2)
library(grid)
library(gridExtra)

# User-defined function
dhms <- function(t){
  paste(paste(formatC(t %/% (60*60) %% 24, width = 2, format = "d", flag = "0")
              ,formatC(t %/% 60 %% 60, width = 2, format = "d", flag = "0")
              ,formatC(t %% 60, width = 2, format = "d", flag = "0")
              ,sep = ":"
  )
  )
}


# Meta Variable
PHASE_LABEL = c("1.Trocar insertion",
                "2.Docking",
                "3.Division of lesser omentum up to the R side of the esophagus",
                "4.Liver Retraction",
                "5.Partial (or Total) omentectomy",
                "6.Ligation of Left gastroepiploic vessels",
                "7.Clearance of soft tissues along the greater curvature",
                "8.Ligation of Right gastroepiploic vein",
                "9.Ligation of right gastroepiploic artery",
                "10.Creation of window for duodenal transection",
                "11.Duodenal transection",
                "12.Ligation of right gastric artery",
                "13.Dissection of LN station 12a",
                "14.Dissection of LN station 8 and 9",
                "15.Dissection of LN station 7 and ligation of Left gastric artery",
                "16.Dissection of LN station 11p",
                "17.Clearance of soft tissue along the lesser curvature",
                "18.Gastric transection",
                "19.Harvesting resected specimen into Endo bag",
                "20.Anastomosis",
                "21.Retrieval of specimen"
)

PHASE_LABEL_1 = c("Trocar insertion",
                "Docking",
                "Division of lesser omentum up to the R side of the esophagus",
                "Liver Retraction",
                "Partial (or Total) omentectomy",
                "Ligation of Left gastroepiploic vessels",
                "Clearance of soft tissues along the greater curvature",
                "Ligation of Right gastroepiploic vein",
                "Ligation of right gastroepiploic artery",
                "Creation of window for duodenal transection",
                "Duodenal transection",
                "Ligation of right gastric artery",
                "Dissection of LN station 12a",
                "Dissection of LN station 8 and 9",
                "Dissection of LN station 7 and ligation of Left gastric artery",
                "Dissection of LN station 11p",
                "Clearance of soft tissue along the lesser curvature",
                "Gastric transection",
                "Harvesting resected specimen into Endo bag",
                "Anastomosis",
                "Retrieval of specimen"
)


phase_color = c("#933439","#892126","#914068","#862c59","#7f587a","#72436a","#62315e"
                                            ,"#404b8f","#283884","#366b9c"
                                            ,"#235d92","#8fb88a","#7ead78",
                          "#6da267","#5b9a56","#4c9045","#eabf2e","#e3953e","#df872b"
                                            ,"#c95639","#60442c")
phase_color_list = list("#933439","#892126","#914068","#862c59","#7f587a","#72436a","#62315e"
                                            ,"#404b8f","#283884","#366b9c"
                                            ,"#235d92","#8fb88a","#7ead78",
                                            "#6da267","#5b9a56","#4c9045","#eabf2e","#e3953e","#df872b"
                                            ,"#c95639","#60442c")

plot_setting = list(panel.background = element_rect(fill = "#14191C",
                                colour = "#14191C",
                                linetype = "solid"),
  panel.grid.major = element_line(linetype = 'solid',
                                colour = "#20282E"), 
  panel.grid.minor = element_line(linetype = 'solid',
                                colour = "#20282E"),
  plot.background = element_rect(fill = "#20282E"),
  axis.text.x=element_text(colour="#ffffff"),
  axis.text.y=element_text(colour="#ffffff"),
  axis.title.x = element_text(colour = "#ffffff"),
  axis.title.y = element_text(colour = "#ffffff"),
  plot.title = element_text(colour = "#ffffff",hjust = 0.5))


BLEEDING_LABEL = c("Normal","Event 1","Event 2")

ID <- c("R00001","R00002","R00003","R00004","R00005","R00007","R00008","R00011"
        ,"R00012","R00013","R00014","R00015","R00016","R00017","R00018","R00019","R00020","R00021")

num_patient <- length(ID)

patient.label <- as.list(ID)

# Load RData
bl.table.list <- get(load(file = "bl.table.list.byphase.Rdata"))
counts <- get(load("his.ble.count.Rdata"))
```


## Patient report


### 1. Summaries
  * ID: hu-sev-02  
  * Surgical Date: 16 March 2018  
  * Center: YUHS Cancer Center  
  * Early Gastric Cancer


```{r message=FALSE, echo=FALSE}
library(DT)
library(dplyr)

tmp_1 <- get(load("change.phbl.dtt.Rdata"))
r_t <- dhms(sum(tmp_1$Duration)/30)
e_c <- sum(tmp_1$`Total Event Count`)
e_t <- dhms(sum(tmp_1$`Total Event Duration`)/30)
summ <- data.frame(r_t,e_t,e_c)
  
colnames(summ) <- c("Total Recording Time","Total Event Time","Total Event Count")

datatable(summ,rownames = FALSE,options = list(autoWidth = FALSE,
                   searching = FALSE,
                   ordering = FALSE,
                   lengthChange = FALSE,
                   lengthMenu = FALSE,
                   pageLength = FALSE,
                   paging = FALSE,
                   info = FALSE,
                   columnDefs = list(list(className = 'dt-center', 
                                          targets = c(0,1,2)))
                   ))%>%
formatStyle('Total Recording Time',
              target = 'row' , `text-align` = 'center')%>%
formatStyle('Total Event Time', `text-align` = 'center')



```

### 2. Surgical Phase Labels

```{r message=FALSE, echo=FALSE}
library(DT)
library(dplyr)
PHASE_table <- data.frame(Index=1:21,PHASE_LABEL_1)
colnames(PHASE_table) <- c("Index","Phase")

datatable(PHASE_table, rownames = FALSE, options = list(autoWidth = FALSE,
                   searching = FALSE,
                   ordering = FALSE,
                   lengthChange = FALSE,
                   lengthMenu = FALSE,
                   pageLength = FALSE,
                   paging = FALSE,
                   info = FALSE,
 columnDefs = list(list(className = 'dt-center', targets = 0))
))%>%
formatStyle('Index', `text-align` = 'center')

```


### 3. Workflow Analysis (Phase Analysis)

#### 3.1 Surgical Time x Phase
```{r message=FALSE, echo=FALSE,Fig12,fig.height=10, fig.width=12}
demo.c.dttable<- get(load(file="change.phbl.dtt.Rdata"))
n <- nrow(demo.c.dttable)
total.frame <- sum(demo.c.dttable$Duration)
MAX_duration <- max(demo.c.dttable$Duration)
#workflow.frame <- list()
workflow.frame.mat <- c()
workflow.phase.mat <- c()
for(i in 1:n){
  workflow.frame<- demo.c.dttable$`Start Frame`[[i]]:demo.c.dttable$`End Frame`[[i]]
  workflow.phase <- rep(demo.c.dttable$`Current Phase`[i],demo.c.dttable$Duration[i])
  if(length(workflow.frame)!=MAX_duration){
    workflow.frame <- c(workflow.frame,rep(NA,(MAX_duration-length(workflow.frame))))
    workflow.phase <- c(workflow.phase,rep(NA,(MAX_duration-length(workflow.phase))))
  }
  workflow.frame.mat<- cbind(workflow.frame.mat,workflow.frame)
  workflow.phase.mat<- cbind(workflow.phase.mat,workflow.phase)
}
colnames(workflow.frame.mat) <- NULL
rownames(workflow.frame.mat) <- NULL
colnames(workflow.phase.mat) <- NULL
rownames(workflow.phase.mat) <- NULL

workflow.color <- c()
for(i in 1:n){
  workflow.color[i] = phase_color[demo.c.dttable$`Current Phase`[i]]
}



time_label <- seq(from=0,to =ceiling(total.frame/54000)*54000,by =54000 )
par(bg="#20282E")
matplot(workflow.frame.mat,workflow.phase.mat,type = "l", xlab = "Time",ylab = "Phase",
        main = "Workflow Analysis",col = workflow.color,fg="#ffffff",col.axis ="#ffffff"
        ,col.lab = "#ffffff",col.main="#ffffff",bg ="#20282E",lwd = 7,xaxt="n",yaxt="n")

rect(par('usr')[1], par('usr')[3], par('usr')[2], par('usr')[4], col = "#14191C")
par(new=TRUE)
matplot(workflow.frame.mat,workflow.phase.mat,type = "l", xlab = "Time",ylab = "Phase",
        main = "Workflow Analysis",col = workflow.color,fg="#ffffff",col.axis ="#ffffff"
        ,col.lab = "#ffffff",col.main="#ffffff",lwd = 7,xaxt="n",yaxt="n")
axis(side=2,at=1:21,labels = 1:21,col.ticks = "#ffffff",col.lab= "#ffffff",col = "#ffffff"
     ,col.axis="#ffffff")
axis(side=1,at= time_label,labels = dhms(time_label/30),col.ticks = "#ffffff",col.lab= "#ffffff",col = "#ffffff"
     ,col.axis="#ffffff")
grid(lty =2, lwd=0.1,col="#ffffff")


```

#### 3.2 Change of Phase

```{r message=FALSE, echo=FALSE}
library(DT)
demo.c.dttable<- get(load(file="change.phbl.dtt.Rdata"))
demo.c.dttable$`Start Frame`<- dhms(demo.c.dttable$`Start Frame`/30)
demo.c.dttable$`End Frame`<-dhms(demo.c.dttable$`End Frame`/30)
demo.c.dttable$Duration<-  dhms(demo.c.dttable$`Duration`/30)
demo.c.dttable$`Event 1 Duration`<-  dhms(demo.c.dttable$`Event 1 Duration`/30)
demo.c.dttable$`Event 2 Duration`<-  dhms(demo.c.dttable$`Event 2 Duration`/30)
demo.c.dttable$`Total Event Duration`<-  dhms(demo.c.dttable$`Total Event Duration`/30)


colnames(demo.c.dttable) <- c("Current Phase","Start Time","End Time","Duration"
                               ,"Event 1 Duration","Event 2 Duration",
                               "Total Event Duration"
                               ,"Event 1 Count","Event 2 Count",
                               "Total Event Count")


datatable(demo.c.dttable, options = list(autoWidth = FALSE,
                   searching = FALSE,
                   ordering = FALSE,
                   lengthChange = FALSE,
                   lengthMenu = FALSE,
                   pageLength = FALSE,
                   paging = FALSE,
                   info = FALSE,
  pageLength = length(demo.c.dttable$`Current Phase`)))%>%
formatStyle('Current Phase', `text-align` = 'center')%>%
formatStyle('Start Time', `text-align` = 'center')%>%
formatStyle('End Time', `text-align` = 'center')%>%
formatStyle('Duration', `text-align` = 'center')%>%
formatStyle('Event 1 Duration', `text-align` = 'center')%>%
formatStyle('Event 2 Duration', `text-align` = 'center')%>%
formatStyle('Total Event Duration', `text-align` = 'center')%>%  
formatStyle('Event 1 Count', `text-align` = 'center')%>%
formatStyle('Event 2 Count', `text-align` = 'center')%>%
formatStyle('Total Event Count', `text-align` = 'center')
```


### 4. Phase x Event
```{r message=FALSE, echo=FALSE}
library(DT)
bl.freq.dtt <- get(load(file = "bl.freq.dtt.Rdata"))
bl.freq.dtt$Duration <- dhms(bl.freq.dtt$Duration/30)
bl.freq.dtt$`Normal Duration` <- dhms(bl.freq.dtt$`Normal Duration`/30)
bl.freq.dtt$`Event 1 Duration` <- dhms(bl.freq.dtt$`Event 1 Duration`/30)
bl.freq.dtt$`Event 2 Duration` <- dhms(bl.freq.dtt$`Event 2 Duration`/30)
bl.freq.dtt$`Total Event Duration` <- dhms(bl.freq.dtt$`Total Event Duration`/30)



datatable(bl.freq.dtt,options = list(
  pageLength = 21,autoWidth = FALSE,
                   searching = FALSE,
                   ordering = FALSE,
                   lengthChange = FALSE,
                   lengthMenu = FALSE,
                   pageLength = FALSE,
                   paging = FALSE,
                   info = FALSE))%>%
formatStyle('Phase', `text-align` = 'center')%>%
formatStyle('Duration', `text-align` = 'center')%>%
formatStyle('Normal Duration', `text-align` = 'center')%>%
formatStyle('Event 1 Duration', `text-align` = 'center')%>%
formatStyle('Event 2 Duration', `text-align` = 'center')%>%
formatStyle('Total Event Duration', `text-align` = 'center')%>%
formatStyle('Event 1 Count', `text-align` = 'center')%>%
formatStyle('Event 2 Count', `text-align` = 'center')%>%
formatStyle('Total Event Count', `text-align` = 'center')
```

```{r message=FALSE, echo=FALSE,Fig11,fig.height=7, fig.width=12}
library(ggplot2) 
demo.integ<- get(load(file = "demo.integ.Rdata"))
zero.index<- which(demo.integ$BleedingA==0)
demo.integ <- demo.integ[-zero.index,]

one.index<- which(demo.integ$BleedingA==1)
two.index<- which(demo.integ$BleedingA==2)


time_label <- seq(from=0,to =60*60*3.5*30,by =54000 )
plot <- ggplot(demo.integ, aes(x=seq, y=BleedingA)) + geom_jitter(aes( color = factor(BleedingA)),width = 0.5, height = 0.02) +
        scale_color_manual(values = c("#d04740","#9ba6bd")) +
  ggtitle("Event Flow")+
  labs(y = "Event type",x ="Time")+
  coord_cartesian(ylim=c(0,3)) +
scale_y_continuous(breaks = 0:3,labels = c("","Event 1","Event 2","")) + 
scale_x_continuous(breaks = time_label ,labels = dhms(time_label/30)) +
scale_fill_discrete(name="Event Type")+
theme(panel.background = element_rect(fill = "#14191C",
                                colour = "#14191C",
                                linetype = "solid"),
  panel.grid.major = element_line(linetype = 'solid',
                                colour = "#20282E"), 
  panel.grid.minor = element_line(linetype = 'solid',
                                colour = "#20282E"),
  plot.background = element_rect(fill = "#20282E"),
  axis.text.x=element_text(colour="#ffffff"),
  axis.text.y=element_text(colour="#ffffff"),
  axis.title.x = element_text(colour = "#ffffff"),
  axis.title.y = element_text(colour = "#ffffff"),
  plot.title = element_text(colour = "#ffffff",hjust = 0.5),
  legend.background = element_rect(colour = "#20282E",fill ="#20282E" ),
  legend.title  = element_text(colour = "#ffffff"),
  legend.text = element_text(colour = "#ffffff"),
  legend.key = element_rect(colour = "#20282E",fill ="#20282E" )
  
  )



plot

```


### 5. Comparision with Surgeon's History 

```{r message=FALSE, echo=FALSE,Fig3,fig.height=7, fig.width=12}

y.ax <- list(title = "Event Duration")

x.ax <- list(title = "Phase",  autotick = FALSE,
             type = 'category')


demo.ble<- get(load(file = "freq.ble.frame_1206.Rdata"))
his.table.inte<- get(load(file="his.table.inte.Rdata"))
#his.table.inte$phase <- as.factor(his.table.inte$phase)

his.table.inte <- his.table.inte[order(his.table.inte$phase),]
rownames(his.table.inte) <- NULL


MAX_one <-max(c(his.table.inte$one/30,demo.ble$one_frame/30))
MAX_one_ceil <-ceiling(MAX_one/30)*30
one_tickvals <- seq(0,MAX_one_ceil,30)
one_ticktext <- as.list(dhms(one_tickvals))
#time.labels <-dhms(frame.labels)
one_tickvals <- as.list(one_tickvals)



#box_1 <- plot_ly()



box_1 <- plot_ly(his.table.inte, x = ~phase, y = ~one/30, type = "box",color = I("#ffffff") ,name = "Surgeon's history") %>%
  add_trace(x = demo.ble$ARMES, y = demo.ble$one_frame/30,color=I("#d04740"),type="scatter",mode = 'lines+markers',name = "hu-sev-02",marker=list(size=12))%>%
  layout(title = "Event 1 Duration",yaxis=y.ax,xaxis =x.ax )%>%
 layout(yaxis=list(range=c(0,MAX_one_ceil)))%>%layout(yaxis=list(tickvals = one_tickvals,ticktext = one_ticktext ))%>%
  layout(plot_bgcolor="#14191C",paper_bgcolor= "#20282E", font = list(color = '#ffffff')) 
        
  box_1      
        


MAX_two <-max(c(his.table.inte$two/30,demo.ble$two_frame/30))
MAX_two_ceil <-ceiling(MAX_two/30)*30
two_tickvals <- seq(0,MAX_two_ceil,30)
two_ticktext <- as.list(dhms(two_tickvals))
two_tickvals <- as.list(two_tickvals)




box_2 <-plot_ly(his.table.inte, x = ~phase, y = ~two/30, type = "box",color = I("#ffffff"),name = "Surgeon's history") %>%
  add_trace(x = demo.ble$ARMES, y = demo.ble$two_frame/30,color=I("#9ba6bd"),type="scatter",mode = 'lines+markers',name = "hu-sev-02",marker=list(size=12)) %>%
  layout(title = "Event 2 Duration"
         ,yaxis=y.ax,xaxis =x.ax)%>%
  layout(yaxis=list(range=c(0,MAX_two_ceil)))%>%
  layout(yaxis=list(tickvals = two_tickvals
                    ,ticktext = two_ticktext ))%>%
  layout(plot_bgcolor="#14191C",paper_bgcolor= "#20282E", font = list(color = '#ffffff')) 
  

box_2
#--------------------
MAX_tot <-max(c(his.table.inte$total/30,demo.ble$one_two_frame/30))
MAX_tot_ceil <-ceiling(MAX_tot/30)*30
tot_tickvals <- seq(0,MAX_tot_ceil,30)
tot_ticktext <- as.list(dhms(tot_tickvals))
tot_tickvals <- as.list(tot_tickvals)


box_tot <- plot_ly(his.table.inte, x = ~phase, y = ~total/30,type = "box",name = "Surgeon's history",color = I("#ffffff")) %>%
  add_trace(x = demo.ble$ARMES, y = demo.ble$one_two_frame/30,color=I("#c36317"),type="scatter",mode = 'lines+markers',name = "hu-sev-02",
            marker=list(size=12)) %>%
  layout(title = "Total Event Duration"
         ,yaxis=y.ax,xaxis =x.ax)%>%
  layout(yaxis=list(range=c(0,MAX_tot_ceil)))%>%
  layout(yaxis=list(tickvals = tot_tickvals
                    ,ticktext = tot_ticktext))%>%
  layout(plot_bgcolor="#14191C",paper_bgcolor= "#20282E", font = list(color = '#ffffff')) 
box_tot


```

### 6. Surgical Networks

#### 6.1 Event Networks 


```{r message=FALSE, echo=FALSE,Fig22,fig.height=9, fig.width=12}
library(networkD3)
bl.A.frame <- get(load(file = "bl.A.frame.Rdata"))
bl.A.frame<- data.frame(phase = 1:21,bl.A.frame)[-c(13,16),]
rownames(bl.A.frame) <- NULL
source = rep(0:18,3)   #from
target = rep(c(19,20,21),19)
value = c(bl.A.frame$zero.A,bl.A.frame$one.A,bl.A.frame$two.A)
net <- data.frame(source,target,value)





links <- data.frame(source = net$source, target = net$target, value = net$value)

nodes <- data.frame(
  name=c(name = c(PHASE_LABEL[1:12],PHASE_LABEL[14:15],PHASE_LABEL[17:21],BLEEDING_LABEL)) %>% 
    unique()
)


nodes$group <-as.factor(c(rep("a",4),rep("b",3),rep("c",2),rep("d",2),rep("e",3),"f",rep("g",3),"h","i","j","k"))

links$IDsource <- match(links$source, nodes$name)-1 
links$IDtarget <- match(links$target, nodes$name)-1

my_color <- 'd3.scaleOrdinal() .domain(["a", "b","c","d","e","f","g","h","i","j","k"]) .range(["orange","yellow","green","blue","navy","purple","black","orchid","white","red","grey"])'


sankeyNetwork(Links = links, Nodes = nodes, Source = "source", Target = "target", 
              Value = "value", NodeID = "name", 
              colourScale=my_color, NodeGroup="group", fontSize = 14,iterations = 0)


```



#### 6.2 Phase to Phase Networks
```{r message=FALSE, echo=FALSE,Fig4,fig.height=9, fig.width=12}
library(networkD3)
library(doBy)
#demo <-get(load(paste(getwd(),"/surgical_report/8215811/demo_phase_summ.Rdata",sep = "")))
demo <- get(load("demo_phase_summ.Rdata"))
source = demo$before_phase[2:length(demo$before_phase)] -1 #from
target = (demo$after_phase[2:length(demo$after_phase)]-1+21)
value = demo$duration[1:length(demo$duration)-1]
temp = data.frame(source,target,value)
net = orderBy(~source,temp)
rownames(net) <-NULL

nodes <- data.frame(name = c(PHASE_LABEL, PHASE_LABEL))
links <- data.frame(source = net$source, target = net$target, value = net$value)

nodes$group <-as.factor(c("a","a","a","a","b","b","b","c"
                          ,"c","d","d","e","e","e","e","e","f","g","g","g","h"))


my_color <- 'd3.scaleOrdinal() .domain(["a", "b","c","d","e","f","g","h"]) .range(["orange","yellow","green","blue","navy","purple","black","orchid"])'
sankeyNetwork(Links = links, Nodes = nodes, Source = "source", Target = "target", 
              Value = "value", NodeID = "name", 
              colourScale=my_color, NodeGroup="group", fontSize = 12,iterations = 0)
```

#### 6.3 Phase Networks

```{r message=FALSE, echo=FALSE,Fig5,fig.height=9, fig.width=12}
library(plotly)
library(dplyr)
library(doBy)
demo <- get(load("demo_phase_summ.Rdata"))
source = demo$before_phase[2:length(demo$before_phase)] -1 #from
target = (demo$after_phase[2:length(demo$after_phase)]-1)
value = demo$duration[1:length(demo$duration)-1]
temp = data.frame(source,target,value)
net = orderBy(~source,temp)
rownames(net) <-NULL



plot_ly(
  type = "sankey",
  arrangement="freeform",
  valueformat = ".0f",
  orientation = "h",
  
  node = list(
    label = c(PHASE_LABEL,PHASE_LABEL),
    color = rep(c(rep("blue",4),rep("orchid",3),rep("yellow",2),rep("green",2),rep("red",5),rep("orange",1),rep("purple",3),"navy"),2),
    pad = 15, # distance between 
    thickness = 20,
    line = list(
      color = "black",
      width = 0.5
    )
  ),
  
  link = list(
    source = net$source, #from
    target = net$target, #to 
    value = net$value  #thickness
  )
) %>% 
  layout(
    font = list(
      size = 12
    )
  )
```


## Surgeon Report


### 1. Overall Analysis
```{r message=FALSE, echo=FALSE}
tmp<-list()
tab<-c()
#counts <- get(load("his.ble.count.Rdata"))

for(i in 1:num_patient){
  tmp[[i]] <-data.frame(
    bl.table.list[[i]]$tot_frame,
    bl.table.list[[i]]$bl_frame,
    counts[[i]]$total)
  tab<-rbind(tab,tmp[[i]])
}

stat.md <- apply(tab,2,median)
stat.sd <- apply(tab,2,sd)

stat.md <- t(stat.md)
stat.md[,3] <-round(stat.md[,3],digits = 2)
stat.md[,1:2] <-dhms(stat.md[,1:2]/30)


stat.sd <- t(stat.sd)
stat.sd[,3] <-round(stat.sd[,3],digits = 2)
stat.sd[,1:2] <-dhms(stat.sd[,1:2]/30)

stat.md[,3] <-paste0(stat.md[,3],"(",stat.sd[,3],")")
stat.md[,1] <-paste0(stat.md[,1],"(",stat.sd[,1],")")
stat.md[,2] <-paste0(stat.md[,2],"(",stat.sd[,2],")")


stat <- cbind(cases = length(counts), stat.md)
colnames(stat) <- c("Cases (n)", "Recording Time (Mean, (SD))","Event Time (Mean, (SD))","Event Count (Mean, (SD))")
rownames(stat) <- NULL 
datatable(stat,rownames = FALSE,options = list(
  pageLength = 1,autoWidth = FALSE,
                   searching = FALSE,
                   ordering = FALSE,
                   lengthChange = FALSE,
                   lengthMenu = FALSE,
                   pageLength = FALSE,
                   paging = FALSE,
                   info = FALSE)) %>%
  formatStyle('Cases (n)', `text-align` = 'center') %>%
  formatStyle('Recording Time (Mean, (SD))', `text-align` = 'center') %>%
  formatStyle('Event Time (Mean, (SD))', `text-align` = 'center') %>%
  formatStyle('Event Count (Mean, (SD))', `text-align` = 'center')
```



### 2. Surgeon Analysis

```{r message=FALSE, echo=FALSE}
tmp<-list()
tab<-c()


for(i in 1:num_patient){
  tmp[[i]] <-data.frame(ID[i],bl.table.list[[i]]$tot_time,bl.table.list[[i]]$bl_time,counts[[i]]$total,dhms((bl.table.list[[i]]$bl_frame/30)/counts[[i]]$total))
  tab<-rbind(tab,tmp[[i]])
}
colnames(tab) <- c("ID","Recording Time","Event Time","Event Count (n)","Event Time per Count")


datatable(tab, options = list(
  pageLength = 18,autoWidth = FALSE,
                   searching = FALSE,
                   ordering = FALSE,
                   lengthChange = FALSE,
                   lengthMenu = FALSE,
                   pageLength = FALSE,
                   paging = FALSE,
                   info = FALSE
  )) %>%
  formatStyle('ID', `text-align` = 'center')%>%
  formatStyle('Recording Time', `text-align` = 'center')%>%
  formatStyle('Event Time', `text-align` = 'center')%>%
  formatStyle('Event Time per Count', `text-align` = 'center')
```




### 3. Time Summaries 

#### 3.1 Recording Time 

```{r message=FALSE, echo=FALSE,fig.height=7, fig.width=9}
summ.table <-c()
for(i in 1:num_patient){
  tmp <- data.frame(id = i,`Recording Time` = round(bl.table.list[[i]]$tot_frame/30) ,`Event Time`= round(bl.table.list[[i]]$bl_frame/30) )
  summ.table <- rbind(summ.table,tmp)
}

rownames(summ.table) <- NULL
#-------------------------------------------------------------
y.ax <- list(title = "Time")
x.ax <- list(title = "ID",  autotick = FALSE,
             tickvals =list(1:length(patient.label)),ticktext = patient.label )
max_time = 1800*ceiling(max(summ.table$Recording.Time)/1800)
time_seq = (seq(0,max_time,1800))
time_label = (dhms(seq(0,max_time,1800)))

p_1 <- ggplot(summ.table,aes(x=factor(id), y = Recording.Time))+
geom_bar(stat="identity",fill="#66bbad")+
scale_y_continuous(breaks =time_seq,labels = time_label )+
xlab("Patient ID")+
ylab("Recording Time")+
geom_abline(slope=0,intercept = median(summ.table$Recording.Time),show.legend =TRUE,color = "#ffffff")+
ggtitle("Total Recording Time") + 
theme(panel.background = element_rect(fill = "#14191C",
                                colour = "#14191C",
                                linetype = "solid"),
  panel.grid.major = element_line(linetype = 'solid',
                                colour = "#20282E"), 
  panel.grid.minor = element_line(linetype = 'solid',
                                colour = "#20282E"),
  plot.background = element_rect(fill = "#20282E"),
  axis.text.x=element_text(colour="#ffffff"),
  axis.text.y=element_text(colour="#ffffff"),
  axis.title.x = element_text(colour = "#ffffff"),
  axis.title.y = element_text(colour = "#ffffff"),
  plot.title = element_text(colour = "#ffffff",hjust = 0.5))


ggplotly(p_1)
```

#### 3.2 Event Time 

```{r message=FALSE, echo=FALSE,fig.height=7, fig.width=9}
#-------------------------------------------------------------
max_time = 30*ceiling(max(summ.table$Event.Time)/30)
time_seq = (seq(0,max_time,30))
time_label =(dhms(seq(0,max_time,30)))

p_2 <- ggplot(summ.table,aes(x=factor(id), y = Event.Time))+
geom_bar(stat="identity",fill="#326a71")+
scale_y_continuous(breaks =time_seq,labels = time_label )+
xlab("Patient ID")+
ylab("Event Time")+
geom_abline(slope=0,intercept = median(summ.table$Event.Time),color = "#ffffff")+
ggtitle("Total Event Time") + 
theme(panel.background = element_rect(fill = "#14191C",
                                colour = "#14191C",
                                linetype = "solid"),
  panel.grid.major = element_line(linetype = 'solid',
                                colour = "#20282E"), 
  panel.grid.minor = element_line(linetype = 'solid',
                                colour = "#20282E"),
  plot.background = element_rect(fill = "#20282E"),
  axis.text.x=element_text(colour="#ffffff"),
  axis.text.y=element_text(colour="#ffffff"),
  axis.title.x = element_text(colour = "#ffffff"),
  axis.title.y = element_text(colour = "#ffffff"),
  plot.title = element_text(colour = "#ffffff",hjust = 0.5))
 
ggplotly(p_2)

```

#### 3.3 Event Counts
```{r message=FALSE, echo=FALSE,fig.height=7, fig.width=9}

count.tab <- c()

for(i in 1:num_patient){
  count.tab <- rbind(count.tab,c(i,counts[[i]]$total))
}

count.tab <- as.data.frame(count.tab)
colnames(count.tab) <- c("id","Event.Count")

 p_3 <- ggplot(count.tab,aes(factor(id),Event.Count))+
geom_bar(stat = "identity",fill = "#003445")+
xlab("Patient ID")+
ylab("Event Count")+
geom_abline(slope=0,intercept = median(count.tab$Event.Count),color="#ffffff")+
theme(panel.background = element_rect(fill = "#14191C",
                                colour = "#14191C",
                                linetype = "solid"),
  panel.grid.major = element_line(linetype = 'solid',
                                colour = "#20282E"), 
  panel.grid.minor = element_line(linetype = 'solid',
                                colour = "#20282E"),
  plot.background = element_rect(fill = "#20282E"),
  axis.text.x=element_text(colour="#ffffff"),
  axis.text.y=element_text(colour="#ffffff"),
  axis.title.x = element_text(colour = "#ffffff"),
  axis.title.y = element_text(colour = "#ffffff"),
  plot.title = element_text(colour = "#ffffff",hjust = 0.5))   
   

ggplotly(p_3)


```

### 4. Workflow Analysis (Phase Analysis)

```{r message=FALSE, echo=FALSE,fig.height=7, fig.width=9}
integ.hist.phase <- get(load("integ.hist.phase.time.Rdata"))
colnames(integ.hist.phase) <- c("phase","frame")
integ.hist.phase <- as.data.frame(integ.hist.phase)
MIN = min(integ.hist.phase$frame/30)
MAX = max(integ.hist.phase$frame/30)


frame.labels = seq(0,600*(ceiling(MAX/600)),600)
time.labels = dhms(frame.labels)


############ggplot

p <- ggplot(integ.hist.phase, aes(x= factor(phase,levels = 21:1), y = frame/30)) + 
  geom_boxplot(aes(fill=factor(phase),color =factor(phase) )) +
  scale_fill_manual(values = phase_color) +
  scale_color_manual(values = rep("#ffffff",21))+
  theme(legend.position = "none")+
  coord_flip() +
  xlab("Surgical Phase")+
  ylab("Time (hh:mm:ss)")+
  scale_y_continuous(breaks = frame.labels,labels = time.labels) +
  theme(panel.background = element_rect(fill = "#14191C",
                                colour = "#14191C",
                                linetype = "solid"),
  panel.grid.major = element_line(linetype = 'solid',
                                colour = "#20282E"), 
  panel.grid.minor = element_line(linetype = 'solid',
                                colour = "#20282E"),
  plot.background = element_rect(fill = "#20282E"),
  axis.text.x=element_text(colour="#ffffff"),
  axis.text.y=element_text(colour="#ffffff"),
  axis.title.x = element_text(colour = "#ffffff"),
  axis.title.y = element_text(colour = "#ffffff"),
  plot.title = element_text(colour = "#ffffff",hjust = 0.5)
  )

ggplotly(p)

##############=====================================================================================

phase.table<- get(load("phase.time.stat.Rdata"))  
 #c("phase","aver_time","aver_portion","Min","1Q","2Q","3Q","Max")
 
 
 
 phase.table$aver_time <- dhms(phase.table$aver_time/30)
 phase.table$Min <- dhms(phase.table$Min/30)
 phase.table$`1Q` <- dhms(phase.table$`1Q`/30)
 phase.table$`2Q` <- dhms(phase.table$`2Q`/30)
 phase.table$`3Q` <- dhms(phase.table$`3Q`/30)
 phase.table$Max <- dhms(phase.table$Max/30)
 phase.table$sd <- dhms(phase.table$sd/30)
 
 for(i in 1:length(phase.table$aver_time)){
   phase.table$aver_time[i] = paste0(phase.table$aver_time[i],"(",phase.table$sd[i],")")
 }
 
 
 colnames(phase.table) <- c("Phase","Duration (Mean, (SD))","Proportion (%)","Min"
                            ,"1Q (25th)","2Q (50th)","3Q (75th)","Max","SD")
 phase.table <- phase.table[,c(-3,-9)]



datatable(phase.table, rownames = FALSE, options = list(
  pageLength = 21,autoWidth = FALSE,
                   searching = FALSE,
                   ordering = FALSE,
                   lengthChange = FALSE,
                   lengthMenu = FALSE,
                   pageLength = FALSE,
                   paging = FALSE,
                   info = FALSE
))%>%
  formatStyle('Phase', `text-align` = 'center')%>%
  formatStyle('Duration (Mean, (SD))', `text-align` = 'center')%>%
  formatStyle('Min', `text-align` = 'center')%>%
  formatStyle('1Q (25th)', `text-align` = 'center')%>%
  formatStyle('2Q (50th)', `text-align` = 'center')%>%
  formatStyle('3Q (75th)', `text-align` = 'center')%>%
  formatStyle('Max', `text-align` = 'center')

```


### 5. Event Duration Analysis

```{r message=FALSE, echo=FALSE}
bleeding_history_stat <- get(load("bleeding_history_stat.Rdata"))
bleeding_history_stat$frame_mean <- dhms(bleeding_history_stat$frame_mean/30)
bleeding_history_stat$frame_sd <- dhms(bleeding_history_stat$frame_sd/30)
for(i in 1:length(bleeding_history_stat$frame_mean)){
  bleeding_history_stat$frame_mean[i] <- paste0(bleeding_history_stat$frame_mean[i],"(",bleeding_history_stat$frame_sd[i],")")
}
bleeding_history_stat$X0.<-dhms(bleeding_history_stat$X0./30)
bleeding_history_stat$X25.<-dhms(bleeding_history_stat$X25./30)
bleeding_history_stat$X50. <- dhms(bleeding_history_stat$X50./30)
bleeding_history_stat$X75. <- dhms(bleeding_history_stat$X75./30)
bleeding_history_stat$X100. <- dhms(bleeding_history_stat$X100./30)
bleeding_history_stat <- bleeding_history_stat[,c(-2,-8)]

colnames(bleeding_history_stat) <-  c("Event Duration (Mean, (SD))","Min",
                            "1Q (25th)","2Q (50th)","3Q (75th)","Max")
 
rownames(bleeding_history_stat) <- c("Normal","Event 1",
                                     "Event 2")

bleeding_history_stat_order <- rbind(bleeding_history_stat[2,],
                                     bleeding_history_stat[3,])

datatable(bleeding_history_stat_order, options = list(
  pageLength = 3,autoWidth = FALSE,
                   searching = FALSE,
                   ordering = FALSE,
                   lengthChange = FALSE,
                   lengthMenu = FALSE,
                   pageLength = FALSE,
                   paging = FALSE,
                   info = FALSE
))%>%
  formatStyle('Event Duration (Mean, (SD))', `text-align` = 'center')%>%
  formatStyle('Min', `text-align` = 'center')%>%
  formatStyle('1Q (25th)', `text-align` = 'center')%>%
  formatStyle('2Q (50th)', `text-align` = 'center')%>%
  formatStyle('3Q (75th)', `text-align` = 'center')%>%
  formatStyle('Max', `text-align` = 'center')
```


```{r message=FALSE, echo=FALSE,fig.height=7, fig.width=9}
bleeding_history_frame <- get(load("bleeding_history_frame_dataframe.Rdata"))
bleeding_history_frame$frame <- bleeding_history_frame$frame/30

MIN = min(bleeding_history_frame$frame)
MAX = max(bleeding_history_frame$frame)


frame.labels = seq(0,60*(ceiling(MAX/60)),60)
time.labels = dhms(frame.labels)
event.labels = c("Event 1","Event 2")

p <- ggplot(bleeding_history_frame, aes(factor(bl.type),frame )) + 
  geom_boxplot(fill = c("#d04740","#9ba6bd"),color = "#ffffff") +
  coord_flip() +
  xlab("Event Type") +
  ylab("Time (hh:mm:ss)") +
  scale_y_continuous(breaks = frame.labels,labels = time.labels) +
  scale_x_discrete(labels = event.labels) + 
  ggtitle("Total Event Duration") + 
  theme(panel.background = element_rect(fill = "#14191C",
                                colour = "#14191C",
                                linetype = "solid"),
  panel.grid.major = element_line(linetype = 'solid',
                                colour = "#20282E"), 
  panel.grid.minor = element_line(linetype = 'solid',
                                colour = "#20282E"),
  plot.background = element_rect(fill = "#20282E"),
  axis.text.x=element_text(colour="#ffffff"),
  axis.text.y=element_text(colour="#ffffff"),
  axis.title.x = element_text(colour = "#ffffff"),
  axis.title.y = element_text(colour = "#ffffff"),
  plot.title = element_text(colour = "#ffffff",hjust = 0.5)
  )

ggplotly(p)

#### Event time analysis
bl.time.eachcount <- get(load("bl.time.eachcount.Rdata"))
bl.time.eachcount <- bl.time.eachcount[bl.time.eachcount$bleeding_type != 0 ,]

MAX = max(bl.time.eachcount$duration/30)

frame.labels = seq(0,ceiling(MAX/30)*30,30)
time.labels = dhms(frame.labels)

p_1 <-   ggplot(bl.time.eachcount, aes(factor(id,levels = 18:1),duration/30 )) + 
  geom_boxplot(fill = c("#326a71"),colour = "#ffffff") +
  coord_flip() +
  xlab("Patient ID") +
  ylab("Time (hh:mm:ss)") +
  scale_y_continuous(breaks = frame.labels,labels = time.labels) +
  ggtitle("Event Duration per Count") + 
  theme(panel.background = element_rect(fill = "#14191C",
                                colour = "#14191C",
                                linetype = "solid"),
  panel.grid.major = element_line(linetype = 'solid',
                                colour = "#20282e"), 
  panel.grid.minor = element_line(linetype = 'solid',
                                colour = "#20282e"),
  plot.background = element_rect(fill = "#20282e"),
  axis.text.x=element_text(colour="#ffffff"),
  axis.text.y=element_text(colour="#ffffff"),
  axis.title.x = element_text(colour = "#ffffff"),
  axis.title.y = element_text(colour = "#ffffff"),
  plot.title = element_text(colour = "#ffffff",hjust = 0.5)
  )

ggplotly(p_1)


```

### 6. Event Count Analysis

```{r message=FALSE, echo=FALSE}

hist.blecount.stat <- get(load("hist.blecount.stat.Rdata"))
for(i in 1:length(hist.blecount.stat[,1])){
  hist.blecount.stat[i,1] <- paste0( hist.blecount.stat[i,1],"(",paste0(hist.blecount.stat[i,7],")"))
}



colnames(hist.blecount.stat) <- c("Count (Mean, (SD))","Min"
                            ,"1Q(25th)","2Q(50th)","3Q(75th)","Max","sd")  
rownames(hist.blecount.stat) <- c("Normal","Event 1",
                                     "Event 2")
hist.blecount.stat <- hist.blecount.stat[,-7]

hist.blecount.stat_order <- rbind(hist.blecount.stat[2,],
                                  hist.blecount.stat[3,])

datatable(hist.blecount.stat_order, options = list(
  pageLength = 3,autoWidth = FALSE,
                   searching = FALSE,
                   ordering = FALSE,
                   lengthChange = FALSE,
                   lengthMenu = FALSE,
                   pageLength = FALSE,
                   paging = FALSE,
                   info = FALSE
))%>%
formatStyle('Count (Mean, (SD))', `text-align` = 'center')%>%
formatStyle('Min', `text-align` = 'center')%>%
formatStyle('1Q(25th)', `text-align` = 'center')%>%
formatStyle('2Q(50th)', `text-align` = 'center')%>%
formatStyle('3Q(75th)', `text-align` = 'center')%>%
formatStyle('Max', `text-align` = 'center')
```


```{r message=FALSE, echo=FALSE,fig.height=7, fig.width=9}
#===========boxplot 
bleeding_history_count <- get(load("hist.blecount.dataframe.Rdata"))



MAX = max(bleeding_history_count$count)
count.label = seq(0,MAX,1)
if(MAX>=50){
  count.label = seq(0,MAX,2)
}


bleeding.labels = c("Event 1","Event 2")

p <- ggplot(bleeding_history_count, aes(factor(bl.type),count )) + geom_boxplot(fill = c("#d04740","#9ba6bd"),color = "#ffffff") +
coord_flip() +xlab("Event Type")+ylab("Count (n)")+scale_y_continuous(breaks = count.label) +
scale_x_discrete(labels = bleeding.labels) + ggtitle("Event Count")+
theme(panel.background = element_rect(fill = "#14191C",
                                colour = "#14191C",
                                linetype = "solid"),
  panel.grid.major = element_line(linetype = 'solid',
                                colour = "#20282E"), 
  panel.grid.minor = element_line(linetype = 'solid',
                                colour = "#20282E"),
  plot.background = element_rect(fill = "#20282E"),
  axis.text.x=element_text(colour="#ffffff"),
  axis.text.y=element_text(colour="#ffffff"),
  axis.title.x = element_text(colour = "#ffffff"),
  axis.title.y = element_text(colour = "#ffffff"),
  plot.title = element_text(colour = "#ffffff",hjust = 0.5))

ggplotly(p)


```




### 7. Phase x Event Cross Tabulation
#### 7.1 Phase x Event 1
##### 7.1.1 Event 1 Duration

```{r message=FALSE, echo=FALSE,fig.height=7, fig.width=9}
one.dat <- get(load("his.phb.one.table.list.Rdata"))
integ.data <-c()
for(i in 1:length(one.dat)){
  tmp <- cbind(i,one.dat[[i]]$frame.tab)
  integ.data <- rbind(integ.data,tmp)
}

integ.data<-as.data.frame(integ.data)
colnames(integ.data) <- c("phase","frame")

MIN = min(integ.data$frame/30)
MAX = max(integ.data$frame/30)

frame.labels = seq(0,30*(ceiling(MAX/30)),30)
time.labels = dhms(frame.labels)

p <- ggplot(integ.data, aes(factor(phase,levels = 21:1), frame/30)) + 
  geom_boxplot(aes(fill=factor(phase),color =factor(phase) )) +
  scale_fill_manual(values = phase_color) +
  scale_color_manual(values = rep("#ffffff",21))+
  theme(legend.position = "none")+
  coord_flip() +xlab("Phase") +
  ylab("Time (hh:mm:ss)") +
  scale_y_continuous(breaks = frame.labels,labels = time.labels) + 
  scale_x_discrete()+
theme(panel.background = element_rect(fill = "#14191C",
                                colour = "#14191C",
                                linetype = "solid"),
  panel.grid.major = element_line(linetype = 'solid',
                                colour = "#20282E"), 
  panel.grid.minor = element_line(linetype = 'solid',
                                colour = "#20282E"),
  plot.background = element_rect(fill = "#20282E"),
  axis.text.x=element_text(colour="#ffffff"),
  axis.text.y=element_text(colour="#ffffff"),
  axis.title.x = element_text(colour = "#ffffff"),
  axis.title.y = element_text(colour = "#ffffff"),
  plot.title = element_text(colour = "#ffffff",hjust = 0.5))
ggplotly(p)



#========================

one <- group_by(integ.data, phase)%>% 
summarise(mean=dhms(mean(frame)/30),sd= dhms(sd(frame)/30), min = dhms(min(frame)/30),`1Q(25th)` = dhms(quantile(frame,0.25)/30) ,
          `2Q(50th)` = dhms(median(frame)/30) ,`3Q(75th)` = dhms(quantile(frame,0.75)/30),max = dhms(max(frame)/30))

one$mean <- paste0(one$mean,"(",one$sd,")")
one <- one[,-3]
colnames(one) <- c("Phase","Event 1 Duration (Mean,(SD))","Min","1Q(25th)","2Q(50th)","3Q(75th)","Max")

one <- datatable(one,rownames = FALSE, options = list(
  pageLength = 21,autoWidth = FALSE,
                   searching = FALSE,
                   ordering = FALSE,
                   lengthChange = FALSE,
                   lengthMenu = FALSE,
                   pageLength = FALSE,
                   paging = FALSE,
                   info = FALSE
))%>%
formatStyle('Event 1 Duration (Mean,(SD))', `text-align` = 'center')%>%
formatStyle('Min', `text-align` = 'center')%>%
formatStyle('1Q(25th)', `text-align` = 'center')%>%
formatStyle('2Q(50th)', `text-align` = 'center')%>%
formatStyle('3Q(75th)', `text-align` = 'center')%>%
formatStyle('Max', `text-align` = 'center')

one



```

##### 7.1.1 Event 1 Count
```{r message=FALSE, echo=FALSE,fig.height=7, fig.width=9}
library(dplyr)
library(tidyr)
library(DT)
library(sparkline)
library(plotly)

count.table <- get(load("his.count.table.Rdata"))
one <- count.table[[1]]
#######==================
MIN = min(one$counts)
MAX = max(one$counts)


count.label = seq(0,MAX,1)


p <- ggplot(one, aes(factor(phase,levels = 21:1),counts ))+
  geom_boxplot(aes(fill=factor(phase),color =factor(phase) )) +
  scale_fill_manual(values = phase_color) +
  scale_color_manual(values = rep("#ffffff",21))+
  theme(legend.position = "none")+
coord_flip() +xlab("Phase")+ylab("Count (n)")+scale_y_continuous(breaks = count.label) +
theme(panel.background = element_rect(fill = "#14191C",
                                colour = "#14191C",
                                linetype = "solid"),
  panel.grid.major = element_line(linetype = 'solid',
                                colour = "#20282E"), 
  panel.grid.minor = element_line(linetype = 'solid',
                                colour = "#20282E"),
  plot.background = element_rect(fill = "#20282E"),
  axis.text.x=element_text(colour="#ffffff"),
  axis.text.y=element_text(colour="#ffffff"),
  axis.title.x = element_text(colour = "#ffffff"),
  axis.title.y = element_text(colour = "#ffffff"),
  plot.title = element_text(colour = "#ffffff",hjust = 0.5))
#-----------------------------
ggplotly(p)


#======================



one <- group_by(one,phase)%>%
summarise(mean= round(mean(counts),digits = 2),sd= round(sd(counts),digits = 2) , Min = min(counts),`1Q(25th)` = quantile(counts,0.25),
          `2Q(50th)` = median(counts),`3Q(75th)` = quantile(counts,0.75), Max = max(counts))

one$mean <- paste0(one$mean,"(",one$sd,")")
one <- one[,-3]
colnames(one) <- c("Phase","Event 1 Count (Mean,(SD))","Min","1Q(25th)","2Q(50th)","3Q(75th)","Max")


datatable(one,rownames = FALSE, options = list(
  pageLength = 21,autoWidth = FALSE,
                   searching = FALSE,
                   ordering = FALSE,
                   lengthChange = FALSE,
                   lengthMenu = FALSE,
                   pageLength = FALSE,
                   paging = FALSE,
                   info = FALSE
))%>%
formatStyle('Event 1 Count (Mean,(SD))', `text-align` = 'center')%>%
formatStyle('Min', `text-align` = 'center')%>%
formatStyle('1Q(25th)', `text-align` = 'center')%>%
formatStyle('2Q(50th)', `text-align` = 'center')%>%
formatStyle('3Q(75th)', `text-align` = 'center')%>%
formatStyle('Max', `text-align` = 'center')





```







#### 7.2 Phase x Event 2 

##### 7.2.1 Event 2 Duration
```{r message=FALSE, echo=FALSE,fig.height=7, fig.width=9}
library(dplyr)
library(tidyr)
library(DT)
library(sparkline)
library(ggplot2)
library(ggthemes) 

#######====box plot with ggplot2
MIN = min(integ.data$frame/30)
MAX = max(integ.data$frame/30)


frame.labels = seq(0,30*(ceiling(MAX/30)),30)
time.labels = dhms(frame.labels)


p <- ggplot(integ.data, aes(factor(phase,levels = 21:1), frame/30)) + geom_boxplot(aes(fill=factor(phase),color =factor(phase))) +
  scale_fill_manual(values = phase_color) +
  scale_color_manual(values = rep("#ffffff",21))+
  coord_flip()+ xlab("Phase")+ylab("Time (hh:mm:ss)")+scale_y_continuous(breaks = frame.labels,labels = time.labels)+
theme(panel.background = element_rect(fill = "#14191C",
                                colour = "#14191C",
                                linetype = "solid"),
  panel.grid.major = element_line(linetype = 'solid',
                                colour = "#20282E"), 
  panel.grid.minor = element_line(linetype = 'solid',
                                colour = "#20282E"),
  plot.background = element_rect(fill = "#20282E"),
  axis.text.x=element_text(colour="#ffffff"),
  axis.text.y=element_text(colour="#ffffff"),
  axis.title.x = element_text(colour = "#ffffff"),
  axis.title.y = element_text(colour = "#ffffff"),
  plot.title = element_text(colour = "#ffffff",hjust = 0.5),legend.position = "none")  

ggplotly(p)
#========

two.dat <- get(load("his.phb.two.table.list.Rdata"))
integ.data <-c()
for(i in 1:length(two.dat)){
  tmp <- cbind(i,two.dat[[i]]$frame.tab)
  integ.data <- rbind(integ.data,tmp)
}
integ.data<-as.data.frame(integ.data)
colnames(integ.data) <- c("phase","frame")
two <- group_by(integ.data, phase)%>% 
summarise(mean=dhms(mean(frame)/30),sd= dhms(sd(frame)/30), Min = dhms(min(frame)/30),`1Q(25th)` = dhms(quantile(frame,0.25)/30),
          `2Q(50th)` = dhms(median(frame)/30) ,`3Q(75th)` = dhms(quantile(frame,0.75)/30),Max = dhms(max(frame)/30))
two$mean <- paste0(two$mean,"(",two$sd,")")
two <- two[,-3]
colnames(two) <- c("Phase","Event 2 Duration (Mean, (SD))","Min","1Q(25th)","2Q(50th)","3Q(75th)","Max")


two <- datatable(two,rownames = FALSE, options = list(
  pageLength = 21,autoWidth = FALSE,
                   searching = FALSE,
                   ordering = FALSE,
                   lengthChange = FALSE,
                   lengthMenu = FALSE,
                   pageLength = FALSE,
                   paging = FALSE,
                   info = FALSE
))%>%
formatStyle('Event 2 Duration (Mean, (SD))', `text-align` = 'center')%>%
formatStyle('Min', `text-align` = 'center')%>%
formatStyle('1Q(25th)', `text-align` = 'center')%>%
formatStyle('2Q(50th)', `text-align` = 'center')%>%
formatStyle('3Q(75th)', `text-align` = 'center')%>%
formatStyle('Max', `text-align` = 'center')
  


two


```

##### 7.2.2 Event 2 Count

```{r message=FALSE, echo=FALSE,fig.height=7, fig.width=9}
library(dplyr)
library(tidyr)
library(DT)
library(sparkline)
library(ggplot2)
library(ggthemes) 
count.table <- get(load("his.count.table.Rdata"))
two <- count.table[[2]]
#####======ggplot2================================================================================================
MIN = min(two$counts)
MAX = max(two$counts)

count.label = seq(0,MAX,1)


p <- ggplot(two, aes(factor(phase,levels = 21:1),counts )) + geom_boxplot(aes(fill=factor(phase),color =factor(phase) )) +
  scale_fill_manual(values = phase_color) +
  scale_color_manual(values = rep("#ffffff",21))+ coord_flip() + xlab("Phase")+ylab("Count (n)")+scale_y_continuous(breaks = count.label) +
  theme(panel.background = element_rect(fill = "#14191C",
                                colour = "#14191C",
                                linetype = "solid"),
  panel.grid.major = element_line(linetype = 'solid',
                                colour = "#20282E"), 
  panel.grid.minor = element_line(linetype = 'solid',
                                colour = "#20282E"),
  plot.background = element_rect(fill = "#20282E"),
  axis.text.x=element_text(colour="#ffffff"),
  axis.text.y=element_text(colour="#ffffff"),
  axis.title.x = element_text(colour = "#ffffff"),
  axis.title.y = element_text(colour = "#ffffff"),
  plot.title = element_text(colour = "#ffffff",hjust = 0.5),legend.position = "none")


ggplotly(p)

#================================================================================================

two <- group_by(two,phase)%>%
summarise(mean= round(mean(counts),digits = 2),sd= round(sd(counts),digits = 2), Min = min(counts),`1Q(25th)` = quantile(counts,0.25),
          `2Q(50th)` = median(counts),`3Q(75th)` = quantile(counts,0.75),Max = max(counts))
two$mean <- paste0(two$mean,"(",two$sd,")")
two <- two[,-3]
colnames(two) <- c("Phase","Event 2 Count (Mean, (SD))","Min","1Q(25th)","2Q(50th)","3Q(75th)","Max")



two <- datatable(two,rownames = FALSE, options = list(
  pageLength = 21,autoWidth = FALSE,
                   searching = FALSE,
                   ordering = FALSE,
                   lengthChange = FALSE,
                   lengthMenu = FALSE,
                   pageLength = FALSE,
                   paging = FALSE,
                   info = FALSE
))%>%
formatStyle('Event 2 Count (Mean, (SD))', `text-align` = 'center')%>%
formatStyle('Min', `text-align` = 'center')%>%
formatStyle('1Q(25th)', `text-align` = 'center')%>%
formatStyle('2Q(50th)', `text-align` = 'center')%>%
formatStyle('3Q(75th)', `text-align` = 'center')%>%
formatStyle('Max', `text-align` = 'center')


two

```


#### 7.3 Phase x Total Event 

##### 7.3.1 Total Event Duration

```{r message=FALSE, echo=FALSE,fig.height=7, fig.width=9}
library(dplyr)
library(tidyr)
library(DT)
library(sparkline)

tot.dat <- get(load("his.phb.tot.table.list.Rdata"))
integ.data <-c()
for(i in 1:length(tot.dat)){
  tmp <- cbind(i,tot.dat[[i]]$frame.tab)
  integ.data <- rbind(integ.data,tmp)
}
integ.data<-as.data.frame(integ.data)
colnames(integ.data) <- c("phase","frame")

#========================================================
MIN = min(integ.data$frame/30)
MAX = max(integ.data$frame/30)


frame.labels = seq(0,30*(ceiling(MAX/30)),30)
time.labels = dhms(frame.labels)


p <- ggplot(integ.data, aes(factor(phase,levels = 21:1), frame/30)) +
  geom_boxplot(aes(fill=factor(phase),color =factor(phase) )) +
  scale_fill_manual(values = phase_color) +
  scale_color_manual(values = rep("#ffffff",21))+
  coord_flip() +xlab("Phase")+ylab("Time (hh:mm:ss)")+scale_y_continuous(breaks = frame.labels,labels = time.labels)+
  theme(panel.background = element_rect(fill = "#14191C",
                                colour = "#14191C",
                                linetype = "solid"),
  panel.grid.major = element_line(linetype = 'solid',
                                colour = "#20282E"), 
  panel.grid.minor = element_line(linetype = 'solid',
                                colour = "#20282E"),
  plot.background = element_rect(fill = "#20282E"),
  axis.text.x=element_text(colour="#ffffff"),
  axis.text.y=element_text(colour="#ffffff"),
  axis.title.x = element_text(colour = "#ffffff"),
  axis.title.y = element_text(colour = "#ffffff"),
  plot.title = element_text(colour = "#ffffff",hjust = 0.5),legend.position = "none")
ggplotly(p)





tot <- group_by(integ.data, phase)%>% 
summarise(mean=dhms(mean(frame)/30),sd= dhms(sd(frame)/30), Min = dhms(min(frame)/30),`1Q(25th)` = dhms(quantile(frame,0.25)/30) ,
          `2Q(50th)` = dhms(median(frame)/30) ,`3Q(75th)` = dhms(quantile(frame,0.75)/30),Max = dhms(max(frame)/30))
tot$mean <- paste0(tot$mean,"(",tot$sd,")")
tot <- tot[,-3]
colnames(tot) <- c("Phase","Total Event Duration (Mean, (SD))","Min","1Q(25th)","2Q(50th)","3Q(75th)","Max")


#========
tot <- datatable(tot,rownames = FALSE, options = list(
  pageLength = 21,autoWidth = FALSE,
                   searching = FALSE,
                   ordering = FALSE,
                   lengthChange = FALSE,
                   lengthMenu = FALSE,
                   pageLength = FALSE,
                   paging = FALSE,
                   info = FALSE
))%>%
formatStyle('Total Event Duration (Mean, (SD))', `text-align` = 'center')%>%
formatStyle('Min', `text-align` = 'center')%>%
formatStyle('1Q(25th)', `text-align` = 'center')%>%
formatStyle('2Q(50th)', `text-align` = 'center')%>%
formatStyle('3Q(75th)', `text-align` = 'center')%>%
formatStyle('Max', `text-align` = 'center')



tot


```


##### 7.3.2 Total Event Count

```{r message=FALSE, echo=FALSE,fig.height=7, fig.width=9}

library(dplyr)
library(tidyr)
library(DT)
library(sparkline)


count.table <- get(load("his.count.table.Rdata"))
tot <- count.table[[3]]
#==============
MIN = min(tot$counts)
MAX = max(tot$counts)

count.label = seq(0,MAX,1)


p <- ggplot(tot, aes(factor(phase,levels = 21:1),counts )) + 
   geom_boxplot(aes(fill=factor(phase),color =factor(phase) )) +
  scale_fill_manual(values = phase_color) +
  scale_color_manual(values = rep("#ffffff",21)) +
coord_flip() +xlab("Phase")+ylab("Count (n)")+scale_y_continuous(breaks = count.label) +
 theme(panel.background = element_rect(fill = "#14191C",
                                colour = "#14191C",
                                linetype = "solid"),
  panel.grid.major = element_line(linetype = 'solid',
                                colour = "#20282E"), 
  panel.grid.minor = element_line(linetype = 'solid',
                                colour = "#20282E"),
  plot.background = element_rect(fill = "#20282E"),
  axis.text.x=element_text(colour="#ffffff"),
  axis.text.y=element_text(colour="#ffffff"),
  axis.title.x = element_text(colour = "#ffffff"),
  axis.title.y = element_text(colour = "#ffffff"),
  plot.title = element_text(colour = "#ffffff",hjust = 0.5),legend.position = "none") 
#========================
ggplotly(p)


tot <- group_by(tot,phase)%>%
summarise(mean= round(mean(counts),digits = 2),sd= round(sd(counts),digits = 2) , Min = min(counts),`1Q(25th)` = quantile(counts,0.25),
          `2Q(50th)` = median(counts),`3Q(75th)` = quantile(counts,0.75),Max = max(counts))
tot$mean <- paste0(tot$mean,"(",tot$sd,")")
tot <- tot[,-3]
colnames(tot) <- c("Phase","Total Event Count (Mean, (SD))","Min","1Q(25th)","2Q(50th)","3Q(75th)","Max")



#========
tot <- datatable(tot,rownames = FALSE, options = list(
  pageLength = 21,autoWidth = FALSE,
                   searching = FALSE,
                   ordering = FALSE,
                   lengthChange = FALSE,
                   lengthMenu = FALSE,
                   pageLength = FALSE,
                   paging = FALSE,
                   info = FALSE
))%>%
formatStyle('Total Event Count (Mean, (SD))', `text-align` = 'center')%>%
formatStyle('Min', `text-align` = 'center')%>%
formatStyle('1Q(25th)', `text-align` = 'center')%>%
formatStyle('2Q(50th)', `text-align` = 'center')%>%
formatStyle('3Q(75th)', `text-align` = 'center')%>%
formatStyle('Max', `text-align` = 'center')
tot
#tot$dependencies <- append(tot$dependencies,htmlwidgets:::getDependency("sparkline"))

#tot





```
